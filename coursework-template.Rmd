---
title: "Coursework submission for Transport Data Science (TRAN5340M)"
output:
  pdf_document:
    number_sections: true
# output: github_document
# for html output:
# output:
#   html_document:
#     number_sections: true
# for pdf output:
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

# Introduction

This template contains information and suggested headings for the TDS module.
Do not submit coursework that contains this note or any text (other than the headings) from this template.
It is just designed to get you started. You will submit the .Rmd file and the resulting document as your coursework submission.

As outlined in the module catalogue, the coursework should be:

- A maximum of 3000 words long, excluding code, figure captions and references
- A maximum of 10 pages long, excluding appendices (you should include your best work and think about maximising the use of space - the chunk option `out.width="50%"`, for example, can help with this as outlined [here](https://bookdown.org/yihui/bookdown/figures.html) )


## RMarkdown

This is an R Markdown file.
You can set the output by changing `output: github_document` to something different, like `output: html_document`.
You will need to submit your work as a pdf document, which can be generated by converting html output to pdf (e.g. with the `pagedown` package) or (recommended) by setting the output to `pdf_document`.
The first lines of your RMarkdown document could look something like this to ensure that the output is a PDF document and that the R code does not run (set `eval = TRUE` to make the R code run):

```
---
title: "Coursework submission for Transport Data Science (TRAN5340M)"
output:
  pdf_document:
    number_sections: true
bibliography: references.bib
---

```

```{r, eval=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```



See here for more info: https://rmarkdown.rstudio.com/lesson-2.html


When you open this file in RStudio and click the **Knit** button all R code chunks are run and a markdown file (.md) suitable for publishing to GitHub is generated.

To ensure the document is reproducible, you should include a code chunk that shows which packages you used, e.g.:

```{r, message=FALSE}
# install.packages("remotes")
remotes::install_github("itsleeds/pct")
remotes::install_github("itsleeds/geofabrik")
remotes::install_github("ropensci/stats19")
library(pct)
library(sf)
library(stplanr)
library(tidyverse)
library(tmap)
```

You can add references manually or with `[@citation-key]` references linking to a .bib file like this[@lovelace_stplanr_2017].
And this [@fox_data_2018].


## Including Code

You can include R code in the document as follows:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

# Datasets used

You can get zone, OD and even route data for any city in the UK with the following commands.
We got data for the Isle of Wight with the following commands:

```{r, message=FALSE}
library(pct)
region_name = "isle-of-wight"
z = get_pct_zones(region = region_name)
od = get_od()
od_in_zones = od %>% 
  filter(geo_code1 %in% z$geo_code) %>% 
  filter(geo_code2 %in% z$geo_code) 
desire_lines = od2line(od_in_zones, z)
```


You could get data from OpenStreetMap with the `osmdata` package.

```{r, eval=FALSE}
library(osmdata)
osm_data = opq("isle of wight") %>% 
  add_osm_feature(key = "highway", value = "primary") %>% 
  osmdata_sf()
```

```{r, echo=FALSE}
# to use pre-saved data online you can do something like this:
# saveRDS(osm_data, "osm_data_highways_primary.Rds")
# piggyback::pb_upload("osm_data_highways_primary.Rds")
# piggyback::pb_download_url("osm_data_highways_primary.Rds")
u = "https://github.com/ITSLeeds/TDS/releases/download/0.20.1/osm_data_highways_primary.Rds"
osm_data = readRDS(url(u))
```

You can get large OSM datasets with `geofabrik`:

```{r}
library(geofabrik)
iow_highways = get_geofabrik(name = "Isle of Wight", layer = "lines")
summary(as.factor(iow_highways$highway))
iow_highways2 = iow_highways %>% 
  filter(!is.na(highway)) %>% 
  filter(!str_detect(string = highway, pattern = "primary|track|resi|service|foot"))
summary(as.factor(iow_highways2$highway))
```


You could get road casualty data with the `stats19` pakckage, as shown below.

```{r}
crashes = stats19::get_stats19(year = 2018, output_format = "sf") %>% 
  sf::st_transform(crs = sf::st_crs(z))

crashes_in_region = crashes[z, ]
tm_shape(z) +
  tm_fill("car_driver", palette = "Greys") +
  tm_shape(iow_highways2) +
  tm_lines(col = "green", lwd = 2) +
  tm_shape(osm_data$osm_lines) +
  tm_lines(col = "maxspeed", lwd = 5) +
  tm_shape(crashes_in_region) +
  tm_dots(size = 0.5, col = "red")
```

# Descriptive analysis

```{r}
plot(desire_lines)
```

# Route analysis

See [here](https://geocompr.robinlovelace.net/transport.html#routes) and [here](https://www.r-spatial.org/r/2019/09/26/spatial-networks.html) for details.

```{r, echo=FALSE}
# devtools::install_github("luukvdmeer/sfnetworks")
```


```{r}
sln = SpatialLinesNetwork(iow_highways2)
sln_clean = sln_clean_graph(sln)
plot(sln_clean@sl$`_ogr_geometry_`)
centrality = igraph::edge_betweenness(sln_clean@g)
centrality_normalised = centrality / mean(centrality)
```

```{r}
mapview::mapview(z) +
  mapview::mapview(sln_clean@sl, lwd = centrality_normalised * 3, zcol = "maxspeed")
```





# Additional datasets

# Policy analysis

Here you could explain how you explored answers to policy questions such as:

- how to make the roads safer?
- how to reduce congestion?
- where to build bike parking?

# Discussion

Include here limitations and ideas for further research.

# Conclusion

What are the main things we have learned from this project?

# References

